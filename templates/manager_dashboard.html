{% extends "templates/base.html" %}

{% block title %}Manager Dashboard - AI Restaurant{% endblock %}

{% block content %}
<h2>Manager Dashboard</h2>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <h5>Pending Complaints</h5>
                <h2>{{ pending_complaints.count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <h5>Pending Orders</h5>
                <h2>{{ pending_orders.count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h5>Pending Compliments</h5>
                <h2>{{ pending_compliments.count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <h5>Flagged KB Entries</h5>
                <h2>{{ flagged_kb.count }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- Pending Complaints -->
{% if pending_complaints %}
<div class="card mb-4">
    <div class="card-header">
        <h4>Pending Complaints</h4>
    </div>
    <div class="card-body">
        {% for complaint in pending_complaints %}
        <div class="mb-3 p-3 border rounded">
            <p><strong>Filed by:</strong> {{ complaint.filed_by.username }} | 
               <strong>Against:</strong> {{ complaint.filed_against.username }} |
               <strong>Type:</strong> {{ complaint.get_type_display|default:complaint.type }}</p>
            <p><strong>Description:</strong> {{ complaint.description }}</p>
            {% if complaint.order %}
            <p><small>Related to Order #{{ complaint.order.id }}</small></p>
            {% endif %}
            <a href="{% url 'review_complaint' complaint.id %}" class="btn btn-sm btn-primary">Review</a>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Pending Compliments -->
{% if pending_compliments %}
<div class="card mb-4">
    <div class="card-header">
        <h4>Pending Compliments</h4>
    </div>
    <div class="card-body">
        {% for compliment in pending_compliments %}
        <div class="mb-3 p-3 border rounded">
            <p><strong>Filed by:</strong> {{ compliment.filed_by.username }} | 
               <strong>For:</strong> {{ compliment.filed_against.username }} |
               <strong>Type:</strong> {{ compliment.get_type_display|default:compliment.type }}</p>
            <p><strong>Description:</strong> {{ compliment.description }}</p>
            <form method="POST" action="{% url 'review_complaint' compliment.id %}" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="decision" value="Approved">
                <button type="submit" class="btn btn-sm btn-success">Approve</button>
            </form>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Pending Orders with Bids -->
{% if pending_orders %}
<div class="card mb-4">
    <div class="card-header">
        <h4>Pending Orders for Assignment</h4>
    </div>
    <div class="card-body">
        {% for order in pending_orders %}
        <div class="mb-3 p-3 border rounded">
            <p><strong>Order #{{ order.id }}</strong> | 
               <strong>Customer:</strong> {{ order.customer.username }} |
               <strong>Total:</strong> ${{ order.total_amount|floatformat:2 }}</p>
            <p><strong>Items:</strong>
                {% for item in order.items.all %}
                {{ item.menu_item.name }} (x{{ item.quantity }}){% if not forloop.last %}, {% endif %}
                {% endfor %}
            </p>
            
            {% with order_bids=order.bids.filter %}
            {% if order_bids %}
            <p><strong>Bids:</strong></p>
            <ul>
                {% for bid in order.bids.all %}
                <li>{{ bid.delivery_person.username }} - 
                    {% if bid.bid_amount %}Bid: ${{ bid.bid_amount|floatformat:2 }}{% else %}No bid amount{% endif %}
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p><em>No bids yet</em></p>
            {% endif %}
            {% endwith %}
            
            <a href="{% url 'assign_order' order.id %}" class="btn btn-sm btn-primary">Assign Order</a>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Flagged Knowledge Base Entries -->
{% if flagged_kb %}
<div class="card mb-4">
    <div class="card-header">
        <h4>Flagged Knowledge Base Entries</h4>
    </div>
    <div class="card-body">
        {% for entry in flagged_kb %}
        <div class="mb-3 p-3 border border-danger rounded">
            <p><strong>Question:</strong> {{ entry.question }}</p>
            <p><strong>Answer:</strong> {{ entry.answer }}</p>
            <p><small>Rating: {{ entry.rating|floatformat:1 }}/5.0 ({{ entry.rating_count }} ratings)</small></p>
            <p class="text-muted">Note: You can manage these entries in the Django admin panel.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}

